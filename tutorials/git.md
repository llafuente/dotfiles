# Git sheet

## Configuration

### Multiple ssh keys

Generate a key / pub

```
ssh-keygen -t rsa -C "llafuente@xxx.com"
```

.ssh/config

```
Host xxx.com
  HostName xxx.com
  User llafuente@xxx.com
  IdentityFile ~/.ssh/xxx-id_rsa

```

### proxy (http protocol)

    # global
    git config --global http.proxy http://user:pwd@domain.com:8080

    # for a specific domain
    git config --global http.https://domain.com.proxy http://proxyUsername:proxyPassword@proxy.server.com:port
    git config --global http.https://domain.com.sslVerify false

### proxy (ssh protocol)


#### http proxy

.ssh/config

```
Host xxx.com
  HostName xxx.com
    ProxyCommand connect -H user:pwd@domain.com:8080 %h %p
  User xxx@yyy.com
  IdentityFile ~/.ssh/rsa_id
```
#### Socks5 proxy

.ssh/config

```
Host xxx.com
  HostName xxx.com
    ProxyCommand connect -S user:pwd@domain.com:8080 %h %p
  User xxx@yyy.com
  IdentityFile ~/.ssh/rsa_id
```

## .gitignore

### add empty folder to git

create a .gitignore file inside with the following content.

    *
    !.gitignore

### List all ignored files

    git status --ignored

    git ls-files -o -i --exclude-standard

### Remove/ignore unwanted modified files (not commited)

    git update-index --assume-unchanged autogenerated-file.txt

## Remotes

https://help.github.com/categories/managing-remotes/

    git remote -v

    # add origin
    git remote add origin git@github.com:llafuente/*.git

    # rename origin
    git remote set-url origin git@github.com:llafuente/*.git


Sync two remotes

    # origin2/x is behind, merge origin/x
    git branch -t develop2 origin2/develop
    git co develop2
    git merge origin/develop --no-ff

    # now origin2/x is foward, so origin/x rebase
    git branch -D develop
    git branch -t develop origin/develop
    git co develop
    git rebase develop2

    git push

## Merge

Merge branch onto branch (Merge the specified branch into the current branch)

    # merge develop onto master
    git co master
    git merge develop --no-ff

## merge and squash

    git co <branch>
    git merge --squash <branch>
    # ERROR: fatal: Not possible to fast-forward, aborting.
    git -c merge.ff merge --squash <branch>


## Merge directory

If target branch is ahead at least 2 commits, you are OK

    git merge develop --no-commit --squash

    # now remove unwanted staff fromt stage
    # new files:
    git rm --cached <file>
    # modified files:
    git co -- <file>

    git commit

## Working copy

Remove all locally deleted files

    git rm $(git ls-files --deleted)

## Log / show

Display all changes from file/folder

    git log -p <file-or-folder>

Display all changes from file/folder and also changes from merges

    git log -p -c <file-or-folder>

Display all changes from file/folder and also changes from merges and ignore whitespace!!

    git log -p -c -b <file-or-folder>

Change file modes to git ones.

    git diff --summary | grep --color 'mode change 100755 => 100644' | cut -d' ' -f7- | xargs -d'\n' chmod +x
    git diff --summary | grep --color 'mode change 100644 => 100755' | cut -d' ' -f7- | xargs -d'\n' chmod -x

Show differences word by word

    git diff --color-words

Show what it's going to be commited: show diff staged

    git diff --cached

## BRANCHING

Create branches

    git branch <name>
    git checkout <name>

Create branches with no history (orphan). Useful for github-pages (gh-pages)

    git checkout --orphan <name>


Sometime branch do not track exactly the origin/branch, use tracking.

    git branch -t develop origin/develop
    git branch -t master origin/master

clear local branches if invalid

    git fetch --prune origin

Reallocate/move branch pointer to different commit

    git update-ref -m "<branch> to <commit>" refs/heads/<branch> <commit>
    # or
    git branch -f <branch> <commit>

Get current branch

    git rev-parse --abbrev-ref HEAD


Get last commit sha1 of a branch

    git fetch # to update repo
    # origin
    git ls-remote origin <branch>

Commits list yet to be applied to current branch

    git checkout <branch1>
    git cherry -v <branch2>

Branch first commit

    git log develop..origin/feature/form-build --oneline | tail -1 | awk '{print $1}'

Branch last commit

    git log develop..origin/feature/form-build --oneline | head -1 | awk '{print $1}'

If you didn't merge other branches inside yours, you can have an accurate diff
of what you did

    C1=$(git log develop..origin/feature/form-build --oneline | tail -1 | awk '{print $1}')
    C2=$(git log develop..origin/feature/form-build --oneline | head -1 | awk '{print $1}')
    git diff ${C1}..${C2} --stat
    # include & exlude support
    git diff ${C1}..${C2} --stat -- '*.js' ':(exclude)spec-path/'

Stats per author

    git log --author="Luis Lafuente Morales" --oneline --shortstat -- . ":(exclude)dashboard/src" ":(exclude)dashboard/thin2-fe/src/styles" | grep " file" | awk 'BEGIN {insertions = 0; deletions = 0;} { split($0,a,\",\"); insertions+=a[2]; deletions += a[3]; } END { print \"insertions\", insertions, \" deletions\", deletions; }'

### Delete branches

Delete local branch

    git br -d <branch>

Delete remote branch

    git push --delete origin <branch>


# know if a branch is merged into branch

test *local* branches

master lists branches merged into master

    git branch --merged develop

lists branches merged into HEAD (i.e. tip of current branch)

    git branch --merged

lists branches that have not been merged

    git branch --no-merged

test *origin* branches `-a`, only remotes `-r`

## BISECT

    git bisect start

    # select initial range

    git bisect good <revision>
    git bisect bad <revision>

    # git will move you to the middle
    # mark the current revision as good/bad until the end (revision not needed)

    # git bisect good
    # git bisect bad

    # finish the bisect
    git bisect end


## Stash

Create stash

    git stash

Create stash with a message

    git stash save "message"

List stash

    git stash list

Show changes from a stash

    git show stash@{0}

Restore (pop) a stash

    git stash pop

Restore a single file from specific stash

    git checkout stash@{0} -- <filename>

Show file from a stash

    git show stash@{0}:<filename>

## PATCHES

Create a single commit patch

    git format-patch -1 <sha>

Create a range of commit patch

    # X is a number!
    git format-patch -X <sha> --stdout > X-last-commits.patch

Create a patch from two revisions

    git diff <sha1>..<sha2> > diff.patch

Create a patch from current working copy

    git diff > file.patch
    # include staged changes ?
    git diff --cached > file.patch
    # include binaries? maybe: --full-index
    git diff --binary > file.patch

Create a patch from stash

    git stash show -p --color=never > patch.patch
    # NOTE! powershell output is UTF-16 use: | Out-File patch.patch -Encoding utf8


Get file from stash (useful to make partial patches in working copy)

    git checkout 'stash@{0}' -- <path-to-file>

Get file from history (restore file)

    git checkout <sha1> -- <path-to-file>

Get a file from index

    git log -p <path-to-file>
    # search for the index, example: index 6ce1aa3..0000000
    # left side is the "previous", right side the "current"
    # 0000000 means deleted in this example
    git show 6ce1aa3

Apply a patch

    patch -p1 < file.patch # After apply remember to commit :)
    #or
    git apply -v file.patch

Apply a patch created using format-patch

    git am patch1.patch


Add to stage only non-whitespace changes
    git diff -U0 -w --no-color | git apply --cached --ignore-whitespace --unidiff-zero -
    # Note all whitespace changes are not discarded

Apply a commit into current branch ignore whitespace changes

   git format-patch -b -w -1 c5af3e6 --stdout | git apply

## TAGS

Remove tag

    TAG="xxxx"
    git tag -d ${TAG}
    git push origin :refs/tags/${TAG}

Move tag

    TAG="xxxx"
    git tag -f -a ${TAG}
    git push -f --tags

Closest tag

    git describe --tags `git rev-list --tags --max-count=1`

Remove local tags that are no longer on the remote repository

    git tag -l | xargs git tag -d # delete all local tags, so becareful!
    git fetch # fetch all tags!


# History operations


Fix last commit, adding new changes / change message

    git commit --amend

Reset/revert last commit

    # put it back in the working copy
    git reset --soft HEAD~1
    # discarding changes
    git reset --hard HEAD~1
    # preserving local changes in index
    git reset --mixed HEAD~1

Revert file to a previous commit

    git checkout <sha1>~1 -- path-to-file

[rewrite author & email](https://help.github.com/articles/changing-author-info)


Force all commits to single author

    git filter-branch --env-filter '
    CORRECT_NAME="llafuente"
    CORRECT_EMAIL="llafuente@noboxout.com"
    export GIT_COMMITTER_NAME="$CORRECT_NAME"
    export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"
    export GIT_AUTHOR_NAME="$CORRECT_NAME"
    export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"
    ' --tag-name-filter cat -- --branches --tags

## Rebase and conflicts

To put branch1 above branch2

    git co branch1
    git rebase branch2

Resolve collisions

    git co --theirs <file> # branch1/<file> is the good one
    git co --ours <file> # branch2/<file> is the good one

When status is clean (all added successfully)

    git rebase --continue

If the current commit is not needed

    git rebase --skip

Call Houston otherwise

    git rebase --abort


Resolve all conflicts at once

    for FILE in `git status | grep "both modified" | awk '{print $4;}'`
    do
      echo $FILE
      git co --theirs $FILE # or --ours
      git add $FILE
    done


Use this with caution.

    git push


    # it may happen that...
    # ! [rejected]        XXX -> XXX (non-fast-forward)
    # Are you sure that your branch has the good history... is the real one
    # You, are... continue
    git push --delete origin branch1
    git push -u origin branch1


## Sync Fork

When you see in github `This branch is x commits behind xx:xx`

    git remote add upstream https://github.com/<user>/<repo>
    git fetch upstream

    git checkout <branch>
    git merge upstream/<branch>


## Display Merge diff


    git show <sha1>

> commit 0e1329e551a5700614a2a34d8101e92fd9f2cad6 (HEAD, master)
> Merge: fc17405 ee2de56

And you see this is shit, Thanks for the information Git!
git diff of merge sha1s (reversed) to see the real merge

    git diff ee2de56..fc17405
    git diff --name-only ee2de56..fc17405


## History. Edit an incorrect commit message

    git rebase -i HEAD~<number>

Change pick to reword, (vi) `:wq`, edit each message and save.


## History. Edit an incorrect commit message with a pattern

Use sed/regex

    git filter-branch -f --msg-filter "sed 's/xxx/yyy/'" <commit>..HEAD


## git flow init (error)

This maybe needed, depends on how your repo is cloned

    git branch -t develop origin/develop
    git branch -t master origin/master
    git flow init



## Get the git root directory

    git rev-parse --show-toplevel

## Manual rebase (using cherry-pick)

    git stash # maybe needed
    git branch tmp
    git checkout tmp
    git branch -D develop
    git branch -t develop origin/develop
    git checkout develop
    git pull
    git cherry-pick 000000
    git push
    git branch -D tmp

## Squash commits


    git rebase -i HEAD~3
    # now follow the instructions
    # I like to use 'r' (rework) on the first one, 's' on the rest
    # NOTE: commands are executed from top to bottom.


    # there is another method :) that it's a bit faster: leave everything in the stage (no new files)
    git reset HEAD~3
    git commit -a -m "xxxx"

## Remove untracked files and folders

     git clean -fd
     # NOTE add -x if files to remove are ignored


## Move folder from one repository to another one

https://stackoverflow.com/questions/19097259/how-to-move-a-git-repository-into-another-directory-and-make-that-directory-a-gi
http://gbayer.com/development/moving-files-from-one-git-repository-to-another-preserving-history/


## Smart add, only some part of a file (interative)

    git add -e file

This let you decide what hunks add to stage.

## Add file with executable permission (chmod)

    git update-index --chmod=+x <file>
    # then, it's already staged
    git commit

## Recover a dropped stash in Git

    git fsck --no-reflog
    # choose any <sha1>
    git show <sha1>

    # apply to the current working directory
    git show <sha1> . | git apply -3
